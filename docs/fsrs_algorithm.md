# FSRS (Free Spaced Repetition Scheduler) アルゴリズム

## 概要

FSRSは、記憶の忘却曲線をモデル化した最新の間隔反復アルゴリズムです。
従来のSM-2（Anki標準）より科学的根拠に基づき、個人の記憶パターンに適応します。

## アルゴリズムの流れ

```
┌─────────────────────────────────────────────────────────────────┐
│                      カード学習フロー                            │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │ 新規カード │
    │  (NEW)   │
    └────┬─────┘
         │
         ▼
┌─────────────────┐
│   カード表示     │◄──────────────────────────────┐
│   (表面を見る)   │                               │
└────────┬────────┘                               │
         │                                        │
         ▼                                        │
┌─────────────────┐                               │
│   答えを表示     │                               │
│   (裏面を見る)   │                               │
└────────┬────────┘                               │
         │                                        │
         ▼                                        │
┌─────────────────────────────────────────────┐   │
│              自己評価を選択                   │   │
├─────────┬─────────┬─────────┬───────────────┤   │
│ もう一度 │ 難しい  │  良い   │    簡単       │   │
│ (Again) │ (Hard)  │ (Good)  │   (Easy)      │   │
│  1分    │  6分    │  10分   │    4日        │   │
└────┬────┴────┬────┴────┬────┴───────┬───────┘   │
     │         │         │            │           │
     ▼         ▼         ▼            ▼           │
┌─────────────────────────────────────────────┐   │
│         FSRS アルゴリズム計算                │   │
│  ┌─────────────────────────────────────┐    │   │
│  │ 新しい Stability (安定性) を計算     │    │   │
│  │ 新しい Difficulty (難易度) を計算    │    │   │
│  │ 次回復習日 (Due) を計算              │    │   │
│  └─────────────────────────────────────┘    │   │
└────────────────────┬────────────────────────┘   │
                     │                            │
                     ▼                            │
              ┌──────────────┐                    │
              │ CardState    │                    │
              │ を更新       │                    │
              └──────┬───────┘                    │
                     │                            │
                     ▼                            │
              ┌──────────────┐                    │
              │ ReviewLog    │                    │
              │ を記録       │                    │
              └──────┬───────┘                    │
                     │                            │
                     ▼                            │
              ┌──────────────┐     復習期限到来   │
              │  次回復習日   │─────────────────►─┘
              │  まで待機     │
              └──────────────┘
```

## 主要パラメータ

### Stability (安定性)
- 記憶がどれだけ定着しているかを示す
- 高いほど長い間隔で復習可能
- 正解するほど増加

```
Stability の変化例:

新規 → Good評価 → Good評価 → Good評価 → Easy評価
 0.0      1.0        2.5        6.3       18.9
                     ↑
              復習ごとに増加
```

### Difficulty (難易度)
- そのカードがどれだけ難しいか
- 0.0（簡単）〜 10.0（難しい）
- Again評価で増加、Easy評価で減少

```
Difficulty の変化:

         Again    Hard     Good     Easy
          ↑        ↑        →        ↓
        増加     微増     維持     減少
```

### State (学習状態)

```
┌────────────┐     Good/Easy     ┌────────────┐
│  Learning  │ ─────────────────► │   Review   │
│  (学習中)  │                    │  (復習)    │
└────────────┘                    └─────┬──────┘
      ▲                                 │
      │                                 │ Again
      │                                 ▼
      │                          ┌────────────┐
      └────────────────────────── │ Relearning │
            Good/Easy             │ (再学習)   │
                                  └────────────┘
```

## 復習間隔の計算

FSRSは以下の式で次回復習間隔を計算します：

```
interval = stability × log(desired_retention) / log(0.9)

例: stability = 10, desired_retention = 0.9 の場合
    interval = 10 × log(0.9) / log(0.9) = 10日
```

### 評価ごとの間隔例

| 状態 | Again | Hard | Good | Easy |
|------|-------|------|------|------|
| 新規カード | 1分 | 5分 | 10分 | 4日 |
| 学習中 (stability=1) | 1分 | 10分 | 1日 | 4日 |
| 復習 (stability=10) | 1分 | 6日 | 10日 | 25日 |
| 復習 (stability=30) | 1分 | 18日 | 30日 | 75日 |

## データモデル

### CardState（カードの学習状態）

```python
class CardState:
    card           # 対象カード
    state          # NEW / LEARNING / REVIEW / RELEARNING
    stability      # 安定性 (0.0〜)
    difficulty     # 難易度 (0.0〜10.0)
    due            # 次回復習予定日時
    last_review    # 最終復習日時
    reps           # 復習回数
    lapses         # 忘却回数（Againの回数）
```

### ReviewLog（復習履歴）

```python
class ReviewLog:
    card           # 対象カード
    rating         # 評価 (1=Again, 2=Hard, 3=Good, 4=Easy)
    state          # 復習時の状態
    stability      # 復習時の安定性
    difficulty     # 復習時の難易度
    elapsed_days   # 前回からの経過日数
    scheduled_days # 予定されていた間隔
    review_time    # 復習日時
    duration       # 回答時間（ミリ秒）
```

## SM-2との比較

| 特徴 | SM-2 (Anki標準) | FSRS |
|------|-----------------|------|
| 忘却曲線モデル | 固定式 | 科学的モデル |
| パラメータ数 | 2 (EF, interval) | 19 (最適化可能) |
| 個人適応 | なし | あり |
| 難易度調整 | 線形 | 非線形 |
| 短期復習 | 固定ステップ | 動的計算 |

## 参考資料

- [FSRS GitHub](https://github.com/open-spaced-repetition/fsrs4anki)
- [FSRS Algorithm Wiki](https://github.com/open-spaced-repetition/fsrs4anki/wiki/The-Algorithm)
- [Spaced Repetition研究](https://www.gwern.net/Spaced-repetition)
